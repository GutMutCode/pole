# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Pole** is an LLM-native programming language system where:
- Humans write **specification language** (.pole files) expressing "what" they want
- LLM transforms specs into **implementation language** (Pole IR, .pole-ir files) defining "how"
- **Rust compiler** compiles IR to native code via LLVM backend

This is NOT a transpiler to existing languages - Pole IR is a new language we're designing, compiled to native machine code.

## Architecture

```
[Human] .pole (spec language - natural, intent-focused)
   ‚Üì LLM transformation
[LLM] .pole-ir (implementation language - formal, type-safe)
   ‚Üì Rust compiler (LLVM backend)
[Native] machine code (x86_64, ARM64, etc.)
```

**Hybrid Implementation:**
- **Python layer**: CLI, spec parser/validator, LLM integration (maintained)
- **Rust layer**: IR parser, type checker, LLVM compiler (performance-critical)
- **Integration**: PyO3 bindings connect Python and Rust

## Essential Commands

### Development Workflow

```bash
# 1. Check specification file (.pole)
pole check examples/01-factorial.pole

# 2. Generate IR from spec (requires OPENROUTER_API_KEY)
pole build examples/01-factorial.pole --output output.pole-ir
# OR use mock LLM (no API needed)
pole build examples/01-factorial.pole --mock

# 3. Run IR function
pole run examples/01-factorial.pole-ir factorial 5

# 4. Test all @test_case annotations in IR
pole test examples/01-factorial.pole-ir

# 5. Compile IR to native code (LLVM backend)
cd compiler && cargo run --release --bin polec -- ../examples/01-factorial.pole-ir -o factorial
./factorial  # Run native binary
```

### Verification

```bash
# Before committing
make pre-commit              # Format + verify all

# Individual checks
make verify-specs            # .pole syntax
make verify-ir               # .pole-ir with Rust parser
make update-priority         # Update today's priority
```

## üéØ Current Priority (Week 1, 2025-10-20)

**Active Phase:** Week 1 - Pole Zomboid Demo  
**Goal:** 1-minute playable demo by 2025-10-26

### ‚úÖ Week 1 COMPLETED (Day 1-5)

**Status:** All objectives achieved in 5 days!

**Completed:**
1. ‚úÖ 5 specification files (player, zombie, sprite, tilemap, main)
2. ‚úÖ 418 lines of IR code generated by LLM
3. ‚úÖ 27 functions, 7 types
4. ‚úÖ Rust type checker 90% complete
5. ‚úÖ Pole Engine v0.1 modules
6. ‚úÖ Auto-priority management system

**See:** `docs/reports/WEEK1_COMPLETION.md` for full report

### Next Steps (Week 2)
**Priority:** LLVM compilation + actual gameplay testing

### Pending Task (Day 5 - Friday)
**P1:** Add builtin functions to Rust type checker
- list_get, list_set, list_push
- int_to_float, float_to_int
- See Day 5 section in [docs/WEEK1_PLAN.md](docs/WEEK1_PLAN.md) for details

**Detailed Plan:** See [docs/WEEK1_PLAN.md](docs/WEEK1_PLAN.md)

### Priority Rules

**Hierarchy:** Week Plan > P0 > P1 > P2

- **P0**: Critical - Must complete this week
- **P1**: Important - After P0 completion
- **P2**: Optional - Time permitting

**Before starting work:**
1. ‚úÖ Check this file (CLAUDE.md) for current priority
2. ‚úÖ Check [.claude/PENDING_ISSUES.md](.claude/PENDING_ISSUES.md) for scheduled tasks
3. ‚úÖ Read related guide (WEEK1_PLAN.md)
4. ‚úÖ Confirm with user if unclear

## üîç Development Checklist (MUST FOLLOW)

**IMPORTANT:** When starting development work, you MUST create a TODO list with these steps.

### Quick Checklist (11 Steps)

When user says "ÏßÑÌñâÌï¥Ï§ò":

1. ‚úÖ **[TodoWrite]** Create 11-step checklist
2. ‚úÖ Check dependencies (previous day's work)
3. ‚úÖ Read syntax examples (.pole and .pole-ir)
4. ‚úÖ Test pole CLI tools
5. ‚úÖ Write/edit specification files
6. ‚úÖ Validate with `pole check`
7. ‚úÖ Generate/verify IR
8. ‚úÖ Run all tests on generated IR
9. ‚úÖ Write integration test file (examples/XX-name.pole-ir) **if required by task**
10. ‚úÖ Run integration test
11. ‚úÖ Commit only if all pass

**Detailed Steps:** See [.claude/DEVELOPMENT_CHECKLIST.md](.claude/DEVELOPMENT_CHECKLIST.md)

### Error Handling (Autonomous)

If errors occur, LLM MUST resolve autonomously:

- **Dependency missing** ‚Üí Switch to dependency first ‚Üí Resume
- **Syntax error** ‚Üí Read examples ‚Üí Fix ‚Üí Retry (3x)
- **IR generation failed** ‚Üí Improve prompt ‚Üí Mock ‚Üí Manual
- **Parser error** ‚Üí Re-read examples ‚Üí Fix ‚Üí Retry (3x)
- **Test failure** ‚Üí Analyze ‚Üí Fix logic ‚Üí Retry

**Detailed Protocols:** See [.claude/ERROR_RECOVERY.md](.claude/ERROR_RECOVERY.md)

**Success Rate:** 80-90% autonomous resolution

## Important Conventions

### File Extensions
- `.pole` = Specification language (human-written)
- `.pole-ir` = Implementation language (LLM-generated, formal)
- Never confuse these two! They serve different purposes.

### Syntax Rules
- **`.pole` files:** Use `type Name:` with `fields:` (NOT `type Name = {...}`)
- **`.pole-ir` files:** Use `type Name = {...}` for records
- **Enum types:** Comment in `.pole`, implement as Variant in `.pole-ir`

### LLM Workflow
1. Human writes .pole spec (intentionally incomplete/ambiguous is OK)
2. `pole check` validates spec, detects ambiguities
3. `pole build` sends spec to LLM ‚Üí generates .pole-ir
4. IR is type-checked, contract-verified, tested
5. If errors, LLM may regenerate or request clarification

### Testing Strategy
- Every .pole-ir file should have @test_case annotations
- `pole test` automatically runs all test cases
- Rust compiler has separate test suite (cargo test)

## Code Structure

### Critical Directories
- **examples/**: Specification (.pole) and IR (.pole-ir) example files
- **specs/**: Language specifications (syntax-v0.md, ir-syntax.md, ffi.md)
- **src/pole/**: Python CLI, parser, validator, LLM integration
- **compiler/src/**: Rust IR parser, type checker, LLVM compiler
- **games/zomboid/specs/**: Game specifications (current work)

### Key Example Files
- `examples/03-user-validation.pole` - .pole syntax reference
- `examples/08-simple-record.pole-ir` - .pole-ir syntax reference
- `specs/syntax-v0.md` - Specification language grammar
- `specs/ir-syntax.md` - Implementation language grammar

## Common Issues

### "pole: command not found"
- NixOS: Run `direnv allow` or `nix-shell`
- Others: Set `export PYTHONPATH=src` and `alias pole="python -m pole.cli.main"`

### Python parser errors (expected)
- Python parser is legacy, use for quick checks only
- Rust parser is authoritative: `cd compiler && cargo run --release --bin polec -- ../file.pole-ir`

### Type errors in generated IR
- LLM sometimes generates incorrect types
- Read examples/08-simple-record.pole-ir for correct syntax
- Fix manually or regenerate with better prompt

## Documentation Strategy

**Core docs** (repository root):
- README.md: Project intro, design principles
- ARCHITECTURE.md: System design, component structure
- DEVELOPMENT.md: Developer index, guides
- ROADMAP.md: Development timeline, current phase

**Detailed guides** (docs/guides/):
- LANGUAGE_DEV.md: Language development workflow
- ENGINE_DEV.md: Game engine development
- GAME_DEV.md: Game development with Pole
- AUTOMATION_GUIDE.md: LLM automation (95% automated)
- PRIORITY_ADJUSTMENT.md: Autonomous error recovery

**Claude-specific** (.claude/):
- DEVELOPMENT_CHECKLIST.md: 9-step workflow
- ERROR_RECOVERY.md: Error handling protocols

## Key Files to Read First

1. README.md - Understand the vision
2. ARCHITECTURE.md - System design
3. examples/01-factorial.pole + .pole-ir - See the workflow
4. examples/03-user-validation.pole - Learn .pole syntax
5. examples/08-simple-record.pole-ir - Learn .pole-ir syntax
6. specs/ir-syntax.md - Complete IR grammar
7. .claude/DEVELOPMENT_CHECKLIST.md - Development workflow
8. .claude/ERROR_RECOVERY.md - Error handling

## Quick Commands Reference

```bash
# Priority
make update-priority         # Update today's task

# Development
pole check file.pole         # Validate spec
pole build file.pole         # Generate IR
pole test file.pole-ir       # Run tests

# Verification (before commit)
make verify-specs            # Check all .pole files
make verify-ir               # Check all .pole-ir files  
make pre-commit              # Complete verification

# Automation
make auto-dev FILE=spec.pole # Run complete workflow
```

## License

MIT License - See LICENSE file

---

**Last Updated:** 2025-10-21  
**Current Phase:** Week 1 Day 2 - Zombie specification  
**File Length:** 270 lines (under 500-line limit ‚úÖ)

## ü§ñ Auto Priority System (NEW)

### When You Discover a New Problem

**IMPORTANT:** Before asking the user "Ïñ∏Ï†ú Ï≤òÎ¶¨Ìï¥Ïïº Ìï†Íπå?", run auto-analysis:

```bash
python scripts/auto_priority.py analyze "Problem description with context"
```

**Example:**
```bash
# Good description (includes impact)
python scripts/auto_priority.py analyze \
  "Variant constructors not in scope - blocks player.pole-ir type checking - cannot run demo"

# Output:
# Priority: P1
# ROI: 66.7
# Recommendation: SCHEDULE_NEXT
```

### Decision Protocol

1. **Run auto-analysis** first
2. **If P0 (Critical):**
   - Alert user immediately
   - Create `.claude/DECISION.md` with analysis
   - Update TODO list
   - Execute after 5s (or wait for approval)

3. **If P1 (Important):**
   - Show analysis to user
   - Recommend: "Ïò§Îäò Ïò§ÌõÑ Ï≤òÎ¶¨ÌïòÎäî Í≤ÉÏù¥ Ï¢ãÏùÑ Í≤É Í∞ôÏäµÎãàÎã§ (ROI: XX)"
   - Create `.claude/DECISION.md`
   - Wait for approval

4. **If P2 (Optional):**
   - Document in `.claude/PENDING_ISSUES.md`
   - Recommend: "Week 2Î°ú ÎØ∏Î£®Îäî Í≤ÉÏù¥ Ï¢ãÍ≤†ÏäµÎãàÎã§"
   - Continue current work

### Auto-Analysis Formula

```
ROI = (Impact √ó Urgency) / Complexity

Impact (0-200):
  - Blocks demo: +100
  - Blocks current task: +50
  - Breaks automation: +200
  - Affects multiple files: +20

Urgency (0-100):
  - Days to deadline: 1Ïùº = +100, 5Ïùº = +20
  - Blocks other tasks: +20 per task
  - Can worsen: +30

Complexity (0-200, lower is better):
  - Estimated hours √ó 10
  - High risk: +50
  - Advanced knowledge: +20

Priority:
  - ROI ‚â• 200 ‚Üí P0 (Critical)
  - ROI ‚â• 50 ‚Üí P1 (Important)
  - ROI < 50 ‚Üí P2 (Optional)
```

### Integration with TodoWrite

**After analysis, update TODO automatically:**

```python
# Example usage in LLM workflow
analysis = analyze_issue(problem_description)

if analysis.priority == "P1":
    # Insert at high priority position
    todowrite([
        Todo(id="urgent-1", content=problem_description, 
             status="pending", priority="high"),
        *existing_todos  # Push down existing todos
    ])
```

### Documentation

- **Strategy:** `.claude/AUTO_PRIORITY.md` - Detailed system design
- **Script:** `scripts/auto_priority.py` - Analysis engine
- **Usage:** This section - Quick reference

### Success Metrics

**Before:**
- Problem ‚Üí Ask user ‚Üí Wait ‚Üí Decide (30min+)

**After:**
- Problem ‚Üí Auto-analyze (10s) ‚Üí Recommend ‚Üí User approves ‚Üí Execute
- 90% of decisions automated
- 100% documented

