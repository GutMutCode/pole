# LLM 변환 워크플로우

LLM 변환기가 명세 언어(.pole)를 구현 언어(Pole IR)로 변환할 때 따라야 하는 단계별 프로세스입니다.

## 전체 파이프라인

```
┌─────────────────────────────────────────────────────────────┐
│                     LLM 변환 워크플로우                      │
└─────────────────────────────────────────────────────────────┘

1. [명세 수신] .pole 파일 입력
    ↓
2. [구문 분석] 기본 구조 파싱
    ↓
3. [완전성 검증] ← 핵심! 불명확한 부분 탐지
    ↓
    ├─ 명확함 → 4. [변환 단계]로 진행
    └─ 불명확함 → [질문 생성] → 사용자 응답 대기 → 1로 복귀
    ↓
4. [변환 단계] IR 코드 생성
    ↓
5. [검증 단계] 생성된 코드 검증
    ↓
    ├─ 통과 → 6. [출력]
    └─ 실패 → 3으로 복귀 (재질문 또는 재생성)
    ↓
6. [출력] .pole-ir 파일 생성
```

---

## Step 1: 명세 수신

**입력**: `.pole` 파일
**작업**: 파일 읽기 및 기본 유효성 검사

```
입력 예:
examples/01-factorial.pole
```

---

## Step 2: 구문 분석

**목적**: 명세의 기본 구조를 파악

### 추출할 정보:
- 함수/타입 정의 목록
- 각 요소의 구성 (purpose, input, output, constraints, examples 등)
- 주석 및 메타데이터

### 출력:
구조화된 AST 또는 중간 표현

---

## Step 3: 완전성 검증 ⭐ 핵심 단계

**목적**: 변환 전에 명세가 충분히 명확한지 확인

### 3.1 필수 정보 체크리스트

각 함수/타입에 대해 다음을 확인:

#### 함수의 경우:
- [ ] **목적(purpose)**: 함수가 무엇을 하는지 명확한가?
- [ ] **입력(input)**: 
  - [ ] 모든 매개변수가 정의되었는가?
  - [ ] 각 매개변수의 타입이 명확한가?
  - [ ] 타입이 모호하면 구체적 예시가 있는가?
- [ ] **출력(output)**:
  - [ ] 반환 타입이 정의되었는가?
  - [ ] 여러 값을 반환하는 경우 구조가 명확한가?
- [ ] **제약 조건(constraints)**:
  - [ ] 입력 값의 유효 범위가 정의되었는가?
  - [ ] 에러 조건이 명시되었는가?
  - [ ] 성능 요구사항이 있는가? (선택적이지만 있으면 확인)
- [ ] **예제(examples)**:
  - [ ] 최소 1개 이상의 정상 케이스가 있는가?
  - [ ] 경계 조건 예제가 있는가?
  - [ ] 에러 케이스 예제가 있는가?

#### 타입의 경우:
- [ ] **필드 정의**: 모든 필드가 타입과 함께 정의되었는가?
- [ ] **제약 조건**: 필드 간 관계나 유효성 조건이 명시되었는가?

### 3.2 불명확성 탐지

다음과 같은 패턴을 찾아 불명확성으로 플래그:

#### 모호한 표현:
- "efficiently", "fast", "quickly" → 구체적 성능 목표 없음
- "appropriate", "suitable" → 선택 기준 불명확
- "handle safely", "manage properly" → 구체적 동작 미정의

#### 불완전한 제약:
- "n >= 0" 만 있고 상한이 없음 (오버플로우 가능성)
- "valid email" 검증 기준 불명확
- "list of items" → 리스트 크기 제약 없음

#### 충돌하는 요구사항:
- 예제: input 5 → output 120이지만 constraints에 "output < 100"
- 성능: "최적화" 요구 vs "간단한 구현" 요구

### 3.3 질문 생성 규칙

불명확성 발견 시 다음 형식으로 질문:

```
[불명확] <위치>: <문제 설명>
질문: <구체적 질문>
옵션:
  1. <선택지 1> - <트레이드오프>
  2. <선택지 2> - <트레이드오프>
  3. 기타 (직접 입력)
```

**예시**:
```
[불명확] factorial 함수 - constraints:
문제: "handle overflow if n is too large"에서 오버플로우 처리 방법이 명시되지 않았습니다.

질문: n이 너무 커서 오버플로우가 발생하면 어떻게 처리해야 하나요?
옵션:
  1. 에러 반환 (안전하지만 사용자가 처리 필요)
  2. 임의 정밀도 정수 사용 (느리지만 정확)
  3. 최대값으로 클램핑 (빠르지만 부정확)
  4. 기타 (직접 입력)
```

### 3.4 판단 기준

#### 변환 진행 가능:
- 모든 필수 정보 존재
- 불명확성이 "의도적 모호성" 범위 내
  - 예: "compute efficiently" → 알고리즘 선택을 LLM에 위임 (OK)
  - 예: "return appropriate value" → 무엇을 반환할지 불명확 (NG)

#### 질문 필요:
- 필수 정보 누락
- 모순 발견
- 모호성이 의도적인지 불명확

---

## Step 4: 변환 단계

**전제**: Step 3 통과 (명세가 충분히 명확)

### 4.1 타입 추론
- 명세의 타입 힌트를 IR의 정적 타입으로 변환
- 예: "integer" → `Int`, "list of integers" → `List<Int>`

### 4.2 알고리즘 선택
- 제약 조건과 성능 요구사항을 고려
- 예: fibonacci + "avoid redundant calculations" → 메모이제이션 또는 동적 프로그래밍

### 4.3 에러 처리 생성
- 제약 조건 위반 시 에러 처리 코드 자동 생성
- 예: `constraints: n >= 0` → `if n < 0 then error "negative not allowed"`

### 4.4 코드 생성
- Pole IR 문법에 맞춰 형식적 코드 생성
- 추적성: 원본 명세 위치 메타데이터 포함

### 4.5 다중 후보 (선택 사항)
- 여러 구현 방식 생성
- 각 후보의 트레이드오프 문서화

---

## Step 5: 검증 단계

**목적**: 생성된 IR이 명세를 만족하는지 확인

### 5.1 예제 기반 테스트
- 명세의 모든 examples를 IR로 실행
- 출력이 예상과 일치하는지 확인

### 5.2 제약 조건 검증
- 생성된 코드가 모든 constraints를 만족하는지 정적 분석
- 예: `n >= 0` 제약 → 코드에 입력 검증 로직 존재하는지 확인

### 5.3 타입 체크
- IR의 타입 시스템으로 타입 안전성 검증

### 5.4 검증 실패 처리
- **예제 실패**: 구현 로직 오류 → Step 4로 복귀 (재생성)
- **제약 위반**: 명세 오류 가능성 → Step 3으로 복귀 (재질문)
- **타입 오류**: IR 생성 오류 → Step 4로 복귀

---

## Step 6: 출력

**출력**: `.pole-ir` 파일 + 메타데이터

### 출력 형식:
```
// Generated from: examples/01-factorial.pole
// Timestamp: 2025-01-01 12:00:00
// LLM: claude-3.5-sonnet
// Verification: PASSED

<Pole IR 코드>
```

### 메타데이터:
- 원본 명세 파일 경로
- 생성 타임스탬프
- 사용된 LLM 모델
- 검증 결과
- 의사결정 로그 (어떤 알고리즘을 선택했는지 등)

---

## 예외 상황 처리

### 사용자가 질문에 응답하지 않음
- 타임아웃 후 기본값 사용 (보수적 선택)
- 경고 메시지 포함

### 무한 루프 방지
- 동일한 질문 3회 이상 시 중단
- 사용자에게 명세 재작성 권장

### 부분 변환
- 일부 함수만 명확한 경우 부분 IR 생성 가능
- 불명확한 부분은 TODO 주석으로 표시

---

## 체크리스트 요약

LLM 변환기 구현 시 반드시 포함해야 할 기능:

- [ ] 명세 구문 분석기
- [ ] 완전성 검증 로직
  - [ ] 필수 정보 체크리스트
  - [ ] 불명확성 탐지 패턴
  - [ ] 모순 탐지
- [ ] 질문 생성 엔진
- [ ] 사용자 대화 인터페이스
- [ ] IR 코드 생성기
- [ ] 예제 기반 테스트 실행기
- [ ] 검증 시스템 (타입 체크, 제약 검증)
- [ ] 메타데이터 생성 및 추적

---

## 참고 문서

- [ARCHITECTURE.md](../ARCHITECTURE.md) - 시스템 전체 아키텍처
- [syntax-v0.md](syntax-v0.md) - 명세 언어 문법
- [AGENTS.md](../AGENTS.md) - 개발 가이드라인
